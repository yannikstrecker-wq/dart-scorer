<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dart Turnier – 501 Best of 3</title>

<style>
body{margin:0;background:#050806;color:#f5f5f5;font-family:system-ui;padding:10px}
.panel{background:#111;padding:12px;border-radius:12px;margin-bottom:12px}
.hidden{display:none}
.header{border:2px solid #d4af37;border-radius:12px;padding:10px;background:#000}
.scores{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.player{border:2px solid #0f5d35;border-radius:10px;padding:10px}
.player.active{border-color:#d4af37}
.score{font-size:42px;font-weight:900}
.avg{font-size:14px;color:#ffd700}
.log{font-size:12px;opacity:.85;min-height:16px}
.controls,.numbers{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
.ctrl,.num{padding:12px;font-weight:900;background:#000;color:#fff;border:2px solid #0f5d35;border-radius:8px}
.ctrl.active{background:#d4af37;color:#000}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #333;padding:6px;text-align:center}
.table th{color:#d4af37}
</style>
</head>

<body>

<div class="panel header">
  <h2 id="status">Startmenü</h2>
</div>

<div id="menu" class="panel">
  <button class="ctrl" onclick="startTournament()">501 Turnier starten</button>
</div>

<div id="tournamentPanel" class="panel hidden"></div>
<div id="game" class="panel hidden"></div>

<div id="input" class="panel hidden">
  <div class="controls">
    <button class="ctrl active" onclick="setMult(1)">S</button>
    <button class="ctrl" onclick="setMult(2)">D</button>
    <button class="ctrl" onclick="setMult(3)">T</button>
  </div>
  <div class="numbers" id="nums"></div>
</div>

<script>
/* ================= STATE ================= */
let players=[], scores=[501,501], legs=[0,0];
let turn=0, darts=0, mult=1;
let roundLog=[[],[]], totalPoints=[0,0], totalDarts=[0,0];
let tournament=null, currentMatch=null;

/* ================= ROTATION ================= */
const next = (i,c)=> (i+1)%c;

/* ================= UTILS ================= */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

/* ================= UI ================= */
function setMult(m){
  mult=m;
  document.querySelectorAll(".ctrl").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".ctrl")[m-1].classList.add("active");
}

function buildNums(){
  nums.innerHTML="";
  for(let i=0;i<=20;i++){
    let b=document.createElement("button");
    b.className="num"; b.textContent=i;
    b.onclick=()=>throwDart(i*mult);
    nums.appendChild(b);
  }
  ["Bull","DBull"].forEach((t,i)=>{
    let b=document.createElement("button");
    b.className="num"; b.textContent=t;
    b.onclick=()=>throwDart(i?50:25);
    nums.appendChild(b);
  });
}

function getAvg(i){
  if(!totalDarts[i]) return "0.0";
  return ((totalPoints[i]/totalDarts[i])*3).toFixed(1);
}

function updateGame(){
  game.innerHTML=`
    <div class="scores">
      ${players.map((p,i)=>`
        <div class="player ${i===turn?'active':''}">
          <b>${p}</b>
          <div class="log">${roundLog[i].join(" | ")}</div>
          <div class="score">${scores[i]}</div>
          <div class="avg">Avg: ${getAvg(i)} | Legs: ${legs[i]}</div>
        </div>`).join("")}
    </div>`;
}

/* ================= SPIELLOGIK ================= */
function throwDart(v){
  let nextScore=scores[turn]-v;

  // Bust: unter 0, auf 1, oder kein Double-Out
  if(nextScore<0 || nextScore===1 || (nextScore===0 && v%2!==0)){
    roundLog[turn]=[];
    endTurn();
    return;
  }

  scores[turn]=nextScore;
  roundLog[turn].push(v);
  totalPoints[turn]+=v;
  totalDarts[turn]++;

  if(nextScore===0){
    legs[turn]++;
    if(legs[turn]===2){
      endMatch(players[turn]);
      return;
    }
    // Neues Leg
    scores=[501,501];
    roundLog=[[],[]];
    darts=0;
    turn=next(turn,players.length);
    updateGame();
    return;
  }

  if(++darts>=3) endTurn();
  updateGame();
}

function endTurn(){
  darts=0;
  roundLog[turn]=[];
  turn=next(turn,players.length);
  updateGame();
}

/* ================= TURNIER ================= */
function startTournament(){
  let count=+prompt("Anzahl Spieler (4–8)","4");
  if(count<4||count>8) return;

  let names=[];
  for(let i=0;i<count;i++) names.push(prompt("Name Spieler "+(i+1),"Spieler "+(i+1)));

  tournament={ table:{}, matches:[] };

  names.forEach(n=>tournament.table[n]={p:0,w:0,l:0});

  for(let i=0;i<names.length;i++)
    for(let j=i+1;j<names.length;j++)
      tournament.matches.push({a:names[i],b:names[j]});

  shuffle(tournament.matches);

  menu.classList.add("hidden");
  tournamentPanel.classList.remove("hidden");
  nextMatch();
}

function nextMatch(){
  renderTable();
  if(!tournament.matches.length){
    alert("Turnier beendet");
    location.reload();
    return;
  }
  currentMatch=tournament.matches.shift();
  startMatch(currentMatch.a,currentMatch.b);
}

function startMatch(a,b){
  players=[a,b];
  scores=[501,501];
  legs=[0,0];
  roundLog=[[],[]];
  totalPoints=[0,0];
  totalDarts=[0,0];
  turn=0; darts=0;

  status.textContent=`${a} vs ${b} (Best of 3)`;
  game.classList.remove("hidden");
  input.classList.remove("hidden");
  buildNums();
  updateGame();
}

function endMatch(winner){
  let loser=players.find(p=>p!==winner);
  tournament.table[winner].w++;
  tournament.table[winner].p+=2;
  tournament.table[loser].l++;
  nextMatch();
}

function renderTable(){
  let html=`<h3>Tabelle</h3><table class="table">
    <tr><th>Spieler</th><th>P</th><th>S</th><th>N</th></tr>`;
  Object.entries(tournament.table)
    .sort((a,b)=>b[1].p-a[1].p)
    .forEach(([n,d])=>{
      html+=`<tr><td>${n}</td><td>${d.p}</td><td>${d.w}</td><td>${d.l}</td></tr>`;
    });
  html+="</table>";
  tournamentPanel.innerHTML=html;
}
</script>

</body>
</html>
