<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dart Turnier</title>

<style>
:root{
  --green:#1e7f4f;
  --red:#b8322a;
  --gold:#d4af37;
  --text:#f5f5f5;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:radial-gradient(circle at top,#1b5e3a 0%,#050806 70%);
  font-family:system-ui;
  color:var(--text);
  padding:10px;
}
.app{max-width:1200px;margin:auto}
.panel{background:#111;padding:12px;border-radius:14px;margin-bottom:12px}
.header{text-align:center;border:2px solid var(--gold);border-radius:14px;padding:12px;background:#000}

table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #333;padding:6px;text-align:center}
th{color:var(--gold)}

.scores{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.playerBox{background:#000;border:2px solid #0f5d35;border-radius:12px;padding:10px}
.playerBox.active{border-color:var(--gold)}
.score{font-size:42px;font-weight:900}

.throws,.checkout{text-align:center;font-weight:800}
.checkout{color:#ffd700}

.modes{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.mode{padding:10px;font-weight:900;border-radius:10px;border:2px solid #0f5d35;background:#000;color:#eee}
.mode.active{background:var(--gold);color:#000}

.numbers{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.num{padding:14px;font-size:18px;font-weight:900;background:#000;color:#fff;border:2px solid #0f5d35;border-radius:10px}
.bull{color:#ffd700}

.actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.btn{padding:14px;font-weight:900;border-radius:12px;border:none}
.green{background:var(--green);color:#000}
.red{background:var(--red);color:#fff}

.statBtn,.calBtn{
  position:fixed;bottom:14px;
  background:var(--gold);color:#000;
  font-weight:900;border-radius:50%;border:none;
  padding:12px 14px;font-size:18px
}
.statBtn{right:14px}
.calBtn{left:14px}

.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.9);
  display:none;align-items:center;justify-content:center;z-index:999
}
.overlay.show{display:flex}
.box{
  background:#000;border:3px solid var(--gold);
  border-radius:16px;padding:24px;
  width:90%;max-width:520px;text-align:center
}
.matchRow{display:flex;justify-content:space-between;padding:6px;border-bottom:1px solid #333}
.done{color:#9cffc8}
.wait{color:#aaa}
</style>
</head>

<body>
<div class="app">

<div class="header"><h1>üéØ Dart Turnier</h1></div>

<div class="panel" id="setup">
  <h3>Spielernamen</h3>
  <input id="p0" placeholder="Spieler A1">
  <input id="p1" placeholder="Spieler A2">
  <input id="p2" placeholder="Spieler A3">
  <input id="p3" placeholder="Spieler B1">
  <input id="p4" placeholder="Spieler B2">
  <input id="p5" placeholder="Spieler B3">
  <button class="btn green" onclick="start()">Turnier starten</button>
</div>

<div id="game" style="display:none">

<div class="panel">
  <h3>Gruppentabellen</h3>
  <div id="tables"></div>
</div>

<div class="panel">
  <h3>KO-Phase</h3>
  <div id="koTree"></div>
</div>

<div class="panel">
  <h2 id="matchTitle"></h2>
  <div class="scores">
    <div class="playerBox active" id="box0">
      <div id="n0"></div>
      <div class="score" id="s0">501</div>
      Legs <span id="l0">0</span>
    </div>
    <div class="playerBox" id="box1">
      <div id="n1"></div>
      <div class="score" id="s1">501</div>
      Legs <span id="l1">0</span>
    </div>
  </div>
  <div class="throws" id="throws">Aufnahme: ‚Äì</div>
  <div class="checkout" id="checkout">Checkout: ‚Äì</div>
</div>

<div class="panel">
  <div class="modes">
    <button class="mode active" onclick="setMode(1)">Single</button>
    <button class="mode" onclick="setMode(2)">Double</button>
    <button class="mode" onclick="setMode(3)">Triple</button>
  </div>
  <div class="numbers" id="nums"></div>
  <div class="actions">
    <button class="btn red" onclick="undo()">Undo</button>
    <button class="btn green" onclick="next()">Weiter</button>
  </div>
</div>

</div>

<button class="statBtn" onclick="openStats()">üìä</button>
<button class="calBtn" onclick="openCalendar()">üìÖ</button>

<div class="overlay" id="matchOverlay">
  <div class="box">
    <h2 id="matchWinner"></h2>
    <p id="nextMatchInfo"></p>
    <p><b>üéÑ Steve, du hast einen sch√∂nen Christbaum</b></p>
    <button class="btn green" onclick="closeMatchOverlay()">Weiter</button>
  </div>
</div>

<div class="overlay" id="statsOverlay">
  <div class="box">
    <h2>Statistiken</h2>
    <div id="statList"></div>
    <button class="btn green" onclick="closeStats()">OK</button>
  </div>
</div>

<div class="overlay" id="calendar">
  <div class="box">
    <h2>Spielplan & Ergebnisse</h2>
    <div id="calList"></div>
    <div id="finalRanking"></div>
    <button class="btn green" onclick="closeCalendar()">OK</button>
  </div>
</div>

<script>
/* ================= VARIABLEN ================= */
let players=[],stats=[],groups=[],matches=[],koMatches=[],koResults=[],results={},matchLog=[];
let stage="groups",matchIndex=0,current=0,mode=1;
let score=[501,501],legs=[0,0],darts=[];

/* ================= CHECKOUTS 90‚Äì2 ================= */
const checkoutMap={
90:"T20 D15",89:"T19 D16",88:"T20 D14",87:"T17 D18",
86:"T18 D16",85:"T15 D20",84:"T20 D12",83:"T17 D16",
82:"Bull D16",81:"T19 D12",80:"T20 D10",
79:"T19 D11",78:"T18 D12",77:"T19 D10",
76:"T20 D8",75:"T17 D12",74:"T14 D16",
73:"T19 D8",72:"T16 D12",71:"T13 D16",
70:"T18 D8",69:"T19 D6",68:"T20 D4",
67:"T17 D8",66:"T10 D18",65:"25 D20",
64:"T16 D8",63:"T13 D12",62:"T10 D16",
61:"T15 D8",60:"20 D20",
59:"19 D20",58:"18 D20",57:"17 D20",
56:"16 D20",55:"15 D20",54:"14 D20",
53:"13 D20",52:"12 D20",51:"11 D20",
50:"Bull",49:"9 D20",48:"16 D16",
47:"7 D20",46:"6 D20",45:"5 D20",
44:"4 D20",43:"3 D20",42:"2 D20",
41:"1 D20",40:"D20",38:"D19",36:"D18",
34:"D17",32:"D16",30:"D15",28:"D14",
26:"D13",24:"D12",22:"D11",20:"D10",
18:"D9",16:"D8",14:"D7",12:"D6",
10:"D5",8:"D4",6:"D3",4:"D2",2:"D1"
};

/* ================= START ================= */
function start(){
  players=[];
  for(let i=0;i<6;i++) players.push(document.getElementById("p"+i).value||"Spieler "+(i+1));

  stats=players.map(()=>({
    darts:0,points:0,matches:0,legsWon:0,
    busts:0,checkouts:0,checkoutAttempts:0
  }));

  groups=[
    {idx:[0,1,2],wins:[0,0,0],legsFor:[0,0,0],legsAgainst:[0,0,0]},
    {idx:[3,4,5],wins:[0,0,0],legsFor:[0,0,0],legsAgainst:[0,0,0]}
  ];

  matches=[
    {a:0,b:1,g:0},{a:3,b:4,g:1},
    {a:0,b:2,g:0},{a:3,b:5,g:1},
    {a:1,b:2,g:0},{a:4,b:5,g:1}
  ];

  document.getElementById("setup").style.display="none";
  document.getElementById("game").style.display="block";
  buildNums(); renderTables(); loadMatch();
}

/* ================= FAIR RANKING ================= */
function rankGroup(g){
  return [...g.idx].sort((a,b)=>{
    const ia=g.idx.indexOf(a), ib=g.idx.indexOf(b);
    if(g.wins[ia]!==g.wins[ib]) return g.wins[ib]-g.wins[ia];
    const key1=`${a}-${b}`,key2=`${b}-${a}`;
    if(results[key1]===a||results[key2]===a) return -1;
    if(results[key1]===b||results[key2]===b) return 1;
    const dA=g.legsFor[ia]-g.legsAgainst[ia];
    const dB=g.legsFor[ib]-g.legsAgainst[ib];
    if(dA!==dB) return dB-dA;
    if(g.legsFor[ia]!==g.legsFor[ib]) return g.legsFor[ib]-g.legsFor[ia];
    return Math.random()>0.5?-1:1;
  });
}

/* ================= NUMPAD ================= */
function buildNums(){
  nums.innerHTML="";
  for(let i=1;i<=20;i++) addNum(i);
  addNum(25,"Bull","bull"); addNum(50,"DBull","bull");
}
function addNum(v,l,c){
  const b=document.createElement("button");
  b.className="num "+(c||"");
  b.textContent=l||v;
  b.onclick=()=>throwDart(v);
  nums.appendChild(b);
}

/* ================= MATCH ================= */
function loadMatch(){
  score=[501,501]; legs=[0,0]; darts=[]; current=0;
  const m=stage==="groups"?matches[matchIndex]:koMatches[matchIndex];
  n0.textContent=players[m.a]; n1.textContent=players[m.b];
  matchTitle.textContent=`${players[m.a]} vs ${players[m.b]}`;
  update();
}

function throwDart(v){
  if(darts.length>=3) return;
  const val=v<=20?v*mode:v;
  score[current]-=val;
  darts.push({v,mode,val});

  const p=current===0?(stage==="groups"?matches[matchIndex].a:koMatches[matchIndex].a)
                     :(stage==="groups"?matches[matchIndex].b:koMatches[matchIndex].b);
  stats[p].darts++; stats[p].points+=val;
  update();
}

function undo(){
  if(!darts.length)return;
  const d=darts.pop(); score[current]+=d.val; update();
}

function next(){
  const p=current===0?(stage==="groups"?matches[matchIndex].a:koMatches[matchIndex].a)
                     :(stage==="groups"?matches[matchIndex].b:koMatches[matchIndex].b);

  if(checkoutMap[score[current]]) stats[p].checkoutAttempts++;

  const last=darts.at(-1);
  if(score[current]===0 && last && (last.mode===2||last.v===50)){
    legs[current]++; stats[p].legsWon++; stats[p].checkouts++;
    if(legs[current]===2){ finishMatch(current); return; }
    score=[501,501];
  }
  if(score[current]<0||score[current]===1){
    stats[p].busts++;
    score[current]+=darts.reduce((s,d)=>s+d.val,0);
  }
  current=1-current; darts=[]; update();
}

/* ================= MATCH ENDE ================= */
function finishMatch(w){
  const m=stage==="groups"?matches[matchIndex]:koMatches[matchIndex];
  const winner=w===0?m.a:m.b, loser=w===0?m.b:m.a;

  stats[winner].matches++;
  results[`${winner}-${loser}`]=winner;
  matchLog.push({a:m.a,b:m.b,la:legs[w],lb:legs[1-w]});

  if(stage==="groups"){
    const g=groups[m.g];
    g.wins[g.idx.indexOf(winner)]++;
    g.legsFor[g.idx.indexOf(winner)]+=legs[w];
    g.legsAgainst[g.idx.indexOf(winner)]+=legs[1-w];
    g.legsFor[g.idx.indexOf(loser)]+=legs[1-w];
    g.legsAgainst[g.idx.indexOf(loser)]+=legs[w];
    renderTables();
  }else koResults.push({winner,loser});

  const next = stage==="groups"?matches[matchIndex+1]:koMatches[matchIndex+1];
  nextMatchInfo.textContent = next ? `Als N√§chstes: ${players[next.a]} vs ${players[next.b]}` : "N√§chstes Spiel wird vorbereitet‚Ä¶";

  matchWinner.textContent=`üèÜ ${players[winner]} gewinnt`;
  matchIndex++; matchOverlay.classList.add("show");
}

function closeMatchOverlay(){
  matchOverlay.classList.remove("show");
  if(stage==="groups" && matchIndex===matches.length){ buildKO(); return; }
  if(stage==="ko" && matchIndex===2){ buildFinals(); return; }
  if(stage==="finals" && matchIndex===koMatches.length){ buildFinalRanking(); return; }
  loadMatch();
}

/* ================= KO ================= */
function buildKO(){
  stage="ko"; matchIndex=0; koResults=[];
  const rA=rankGroup(groups[0]), rB=rankGroup(groups[1]);
  koMatches=[{a:rA[0],b:rB[1]},{a:rB[0],b:rA[1]}];
  renderKO(); loadMatch();
}

function buildFinals(){
  stage="finals"; matchIndex=0;
  koMatches=[{a:koResults[0].loser,b:koResults[1].loser},{a:koResults[0].winner,b:koResults[1].winner}];
  renderKO(); loadMatch();
}

function renderKO(){
  koTree.innerHTML="";
  koMatches.forEach((m,i)=>{
    const label=stage==="finals"?(i===0?"ü•â Platz 3":"üèÜ Finale"):"Halbfinale";
    koTree.innerHTML+=`<div>${label}: ${players[m.a]} vs ${players[m.b]}</div>`;
  });
}

/* ================= KALENDER ================= */
function openCalendar(){
  calList.innerHTML="";
  matchLog.forEach(m=>{
    calList.innerHTML+=`
      <div class="matchRow done">
        <span>${players[m.a]} vs ${players[m.b]}</span>
        <span>${m.la} : ${m.lb} ‚úÖ</span>
      </div>`;
  });
  calendar.classList.add("show");
}
function closeCalendar(){calendar.classList.remove("show")}

/* ================= STATISTIK ================= */
function openStats(){
  let h="<table><tr><th>Spieler</th><th>√ò</th><th>Legs</th><th>Matches</th><th>Busts</th><th>CO %</th></tr>";
  stats.forEach((s,i)=>{
    const avg=s.darts?((s.points/s.darts)*3).toFixed(1):"0.0";
    const co=s.checkoutAttempts?((s.checkouts/s.checkoutAttempts)*100).toFixed(0)+"%":"‚Äì";
    h+=`<tr><td>${players[i]}</td><td>${avg}</td><td>${s.legsWon}</td><td>${s.matches}</td><td>${s.busts}</td><td>${co}</td></tr>`;
  });
  h+="</table>"; statList.innerHTML=h; statsOverlay.classList.add("show");
}
function closeStats(){statsOverlay.classList.remove("show")}

/* ================= ENDPLATZIERUNG ================= */
function buildFinalRanking(){
  let r=[koResults[1].winner,koResults[1].loser,koResults[0].winner,koResults[0].loser];
  finalRanking.innerHTML="<h3>üèÜ Endplatzierungen</h3><ol>"+r.map(i=>`<li>${players[i]}</li>`).join("")+"</ol>";
  calendar.classList.add("show");
}

/* ================= UI ================= */
function renderTables(){
  tables.innerHTML="";
  groups.forEach((g,i)=>{
    const rank=rankGroup(g);
    let h=`<h4>Gruppe ${i===0?"A":"B"}</h4><table><tr><th>Pl.</th><th>Spieler</th><th>S</th><th>Legs</th></tr>`;
    rank.forEach((p,pos)=>{
      const j=g.idx.indexOf(p);
      h+=`<tr><td>${pos+1}</td><td>${players[p]}</td><td>${g.wins[j]}</td><td>${g.legsFor[j]}:${g.legsAgainst[j]}</td></tr>`;
    });
    h+="</table>"; tables.innerHTML+=h;
  });
}

function update(){
  s0.textContent=score[0]; s1.textContent=score[1];
  l0.textContent=legs[0]; l1.textContent=legs[1];
  box0.classList.toggle("active",current===0);
  box1.classList.toggle("active",current===1);
  throws.textContent=darts.length?`Aufnahme: ${darts.map(d=>(d.mode===2?"D":d.mode===3?"T":"")+d.v).join(" | ")}`:"Aufnahme: ‚Äì";
  checkout.textContent=checkoutMap[score[current]]?`Checkout: ${checkoutMap[score[current]]}`:"Checkout: ‚Äì";
}
function setMode(m){
  mode=m;
  document.querySelectorAll(".mode").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".mode")[m-1].classList.add("active");
}
</script>
</body>
</html>
