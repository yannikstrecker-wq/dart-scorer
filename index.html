<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dart Turnier ‚Äì 501 | Version 2</title>

<style>
:root{
  --green:#1e7f4f;
  --red:#b8322a;
  --gold:#d4af37;
  --text:#f5f5f5;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:radial-gradient(circle at top,#1b5e3a 0%,#050806 70%);
  font-family:system-ui;
  color:var(--text);
  padding:10px;
}
.panel{background:#111;padding:12px;border-radius:14px;margin-bottom:12px}
.hidden{display:none!important}
.header{
  display:flex;justify-content:space-between;align-items:center;
  border:2px solid var(--gold);border-radius:14px;
  padding:10px;background:#000
}
.ctrl,.num,input{
  padding:10px;font-weight:900;border-radius:10px;
  border:2px solid #0f5d35;background:#000;color:#eee;
  cursor:pointer
}
.ctrl.active{background:var(--gold);color:#000}
.ctrl.zero{border-color:#777;color:#aaa}
.scores{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.player{
  background:#000;border:2px solid #0f5d35;
  border-radius:12px;padding:10px;cursor:pointer
}
.player.active{border-color:var(--gold)}
.score{font-size:42px;font-weight:900}
.avg{font-size:14px;color:#ffd700}
.log{font-size:12px;opacity:.85;min-height:16px}
.controls,.numbers{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #333;padding:6px;text-align:center}
.table th{color:var(--gold)}
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.85);
  display:flex;align-items:center;justify-content:center;z-index:1000
}
.modalBox{
  background:#000;border:2px solid var(--gold);
  border-radius:14px;padding:20px;
  max-width:650px;width:100%;
  text-align:center;font-weight:900
}
.modalBox h3{margin-top:0;color:var(--gold)}
</style>
</head>

<body>

<div class="panel header">
  <h2 id="status">Startmen√º</h2>
  <div>
    <button class="ctrl" onclick="openOverallStats()">üìä Statistik</button>
    <button class="ctrl" onclick="openMatches()">üìã Partien</button>
  </div>
</div>

<div id="menu" class="panel">
  <button class="ctrl" onclick="startTournament()">501 Turnier starten (5 Spieler)</button>
</div>

<div id="tournamentPanel" class="panel hidden"></div>
<div id="game" class="panel hidden"></div>

<div id="input" class="panel hidden">
  <div class="controls">
    <button id="btnS" class="ctrl active" onclick="setMult(1)">S</button>
    <button id="btnD" class="ctrl" onclick="setMult(2)">D</button>
    <button id="btnT" class="ctrl" onclick="setMult(3)">T</button>
    <button class="ctrl zero" onclick="throwMiss()">0</button>
    <button class="ctrl" onclick="undo()">Undo</button>
  </div>
  <input id="scoreInput" type="number" placeholder="Punkte (0‚Äì180)"
    onkeydown="if(event.key==='Enter')submitScore()">
  <div class="numbers" id="nums"></div>
</div>

<!-- BUST -->
<div id="bustOverlay" class="modal hidden">
  <div class="modalBox" style="border-color:#b8322a;color:#ff6b6b;font-size:36px">
    BUST
  </div>
</div>

<!-- Sieger -->
<div id="winnerPopup" class="modal hidden">
  <div class="modalBox">
    <h3 id="winnerText"></h3>
    <div id="nextMatchText"></div><br>
    <button class="ctrl" onclick="closeWinnerPopup()">Weiter</button>
  </div>
</div>

<!-- Spieler-Stats -->
<div id="statsPopup" class="modal hidden">
  <div class="modalBox">
    <h3 id="statsName"></h3>
    <div id="statsContent"></div><br>
    <button class="ctrl" onclick="statsPopup.classList.add('hidden')">Schlie√üen</button>
  </div>
</div>

<!-- Gesamt-Stats -->
<div id="overallStatsPopup" class="modal hidden">
  <div class="modalBox">
    <h3>üìä Gesamtstatistik</h3>
    <div id="overallStatsContent"></div><br>
    <button class="ctrl" onclick="overallStatsPopup.classList.add('hidden')">Schlie√üen</button>
  </div>
</div>

<!-- Partien -->
<div id="matchesPopup" class="modal hidden">
  <div class="modalBox">
    <h3>üìã Spiel√ºbersicht</h3>
    <div id="matchesContent"></div><br>
    <button class="ctrl" onclick="matchesPopup.classList.add('hidden')">Schlie√üen</button>
  </div>
</div>

<script>
/* ================= STATE ================= */
let players=[],scores=[501,501],legs=[0,0];
let turn=0,darts=0,mult=1;
let roundLog=[[],[]],totalPoints=[0,0],totalDarts=[0,0];
let busts=[0,0],schwarzwald=[0,0];
let history=[];
let tournament=null,currentMatch=null;
let overallStats={};

/* ================= MULTI ================= */
function resetMult(){
  mult=1;
  btnS.classList.add("active");
  btnD.classList.remove("active");
  btnT.classList.remove("active");
}
function setMult(m){
  mult=m;
  btnS.classList.toggle("active", m===1);
  btnD.classList.toggle("active", m===2);
  btnT.classList.toggle("active", m===3);
}

/* ================= UTILS ================= */
const next=i=>(i+1)%2;
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}
function getAvg(p,d){return d?((p/d)*3).toFixed(1):"0.0"}
function showBust(){bustOverlay.classList.remove("hidden");setTimeout(()=>bustOverlay.classList.add("hidden"),700)}

/* ================= UI ================= */
function buildNums(){
  nums.innerHTML="";
  for(let i=0;i<=20;i++){
    let b=document.createElement("button");
    b.className="num";b.textContent=i;
    b.onclick=()=>throwDart(i*mult);
    nums.appendChild(b);
  }
  [["Bull",25],["DBull",50]].forEach(x=>{
    let b=document.createElement("button");
    b.className="num";b.textContent=x[0];
    b.onclick=()=>throwDart(x[1]);
    nums.appendChild(b);
  });
}
function updateGame(){
  game.innerHTML=`
    <div class="scores">
      ${players.map((p,i)=>`
        <div class="player ${i===turn?'active':''}" onclick="openPlayerStats(${i})">
          <b>${p}</b>
          <div class="log">${roundLog[i].join(" | ")}</div>
          <div class="score">${scores[i]}</div>
          <div class="avg">
            Avg: ${getAvg(totalPoints[i],totalDarts[i])}
            | Legs: ${legs[i]}
          </div>
        </div>`).join("")}
    </div>`;
}

/* ================= STATISTIK ================= */
function openPlayerStats(i){
  statsName.textContent=players[i];
  statsContent.innerHTML=`
    üéØ Average: <b>${getAvg(totalPoints[i],totalDarts[i])}</b><br>
    üèπ Darts: <b>${totalDarts[i]}</b><br>
    üìä Punkte: <b>${totalPoints[i]}</b><br>
    ‚ùå Busts: <b>${busts[i]}</b><br>
    üå≤ Schwarzwald: <b>${schwarzwald[i]}</b>
  `;
  statsPopup.classList.remove("hidden");
}
function openOverallStats(){
  let html=`<table class="table">
    <tr>
      <th>Spieler</th><th>Avg</th><th>Darts</th>
      <th>Punkte</th><th>Busts</th><th>Schwarzwald</th><th>Siege</th>
    </tr>`;
  Object.entries(overallStats).forEach(([n,s])=>{
    html+=`
      <tr>
        <td>${n}</td>
        <td>${getAvg(s.points,s.darts)}</td>
        <td>${s.darts}</td>
        <td>${s.points}</td>
        <td>${s.busts}</td>
        <td>${s.schwarzwald}</td>
        <td>${s.wins}</td>
      </tr>`;
  });
  html+="</table>";
  overallStatsContent.innerHTML=html;
  overallStatsPopup.classList.remove("hidden");
}

/* ================= SPIEL ================= */
function save(){
  history.push(JSON.stringify({
    scores:[...scores],legs:[...legs],
    roundLog:roundLog.map(r=>[...r]),
    totalPoints:[...totalPoints],totalDarts:[...totalDarts],
    busts:[...busts],schwarzwald:[...schwarzwald],
    turn,darts
  }));
}
function undo(){
  if(!history.length)return;
  let s=JSON.parse(history.pop());
  scores=s.scores;legs=s.legs;roundLog=s.roundLog;
  totalPoints=s.totalPoints;totalDarts=s.totalDarts;
  busts=s.busts;schwarzwald=s.schwarzwald;
  turn=s.turn;darts=s.darts;
  resetMult();
  updateGame();
}
function throwMiss(){
  save();
  schwarzwald[turn]++;
  totalDarts[turn]++;
  roundLog[turn].push(0);
  resetMult();
  if(++darts>=3){darts=0;roundLog[turn]=[];turn=next(turn)}
  updateGame();
}
function submitScore(){
  let v=+scoreInput.value;
  if(!isNaN(v))throwDart(v);
  scoreInput.value="";
}
function throwDart(v){
  save();
  let ns=scores[turn]-v;
  resetMult();
  if(ns<0||ns===1||(ns===0&&v%2!==0)){
    busts[turn]++;
    showBust();
    roundLog[turn]=[];
    darts=0;turn=next(turn);
    updateGame();return;
  }
  scores[turn]=ns;
  roundLog[turn].push(v);
  totalPoints[turn]+=v;
  totalDarts[turn]++;
  if(ns===0){
    legs[turn]++;
    if(legs[turn]===2){endMatch(players[turn]);return;}
    scores=[501,501];roundLog=[[],[]];
    darts=0;turn=next(turn);
    updateGame();return;
  }
  if(++darts>=3){
    darts=0;roundLog[turn]=[];turn=next(turn)
  }
  updateGame();
}

/* ================= TURNIER ================= */
function startTournament(){
  let names=[];
  for(let i=1;i<=5;i++)names.push(prompt("Name Spieler "+i,"Spieler "+i));
  tournament={
    group:[],semi:[],semiWinners:[],semiLosers:[],
    third:null,final:null,all:[]
  };
  overallStats={};
  names.forEach(n=>{
    overallStats[n]={points:0,darts:0,busts:0,schwarzwald:0,wins:0};
  });
  for(let i=0;i<5;i++)
    for(let j=i+1;j<5;j++)
      tournament.group.push({a:names[i],b:names[j],phase:"Gruppe",res:null});
  shuffle(tournament.group);
  tournament.all=[...tournament.group];
  menu.classList.add("hidden");
  renderGroupTable();
  nextGroupMatch();
}
function nextGroupMatch(){
  if(!tournament.group.length){
    renderGroupTable();
    let played=tournament.all.filter(m=>m.phase==="Gruppe"&&m.res);
    let stats={};
    played.forEach(m=>{
      stats[m.a]=(stats[m.a]||0)+(m.res.startsWith("2")?2:0);
      stats[m.b]=(stats[m.b]||0)+(m.res.endsWith("2")?2:0);
    });
    let ranked=Object.keys(stats).sort((a,b)=>stats[b]-stats[a]);
    tournament.semi=[
      {a:ranked[0],b:ranked[3],phase:"Halbfinale",res:null},
      {a:ranked[1],b:ranked[2],phase:"Halbfinale",res:null}
    ];
    tournament.all.push(...tournament.semi);
    startMatch(tournament.semi.shift());
    return;
  }
  startMatch(tournament.group.shift());
}
function startMatch(m){
  currentMatch=m;
  players=[m.a,m.b];
  scores=[501,501];legs=[0,0];
  roundLog=[[],[]];totalPoints=[0,0];totalDarts=[0,0];
  busts=[0,0];schwarzwald=[0,0];
  history=[];turn=0;darts=0;
  status.textContent=`${m.phase}: ${m.a} vs ${m.b}`;
  game.classList.remove("hidden");
  input.classList.remove("hidden");
  buildNums();updateGame();
}
function endMatch(winner){
  let loser=players.find(p=>p!==winner);
  currentMatch.res=`${legs[players.indexOf(winner)]}:${legs[players.indexOf(loser)]}`;
  players.forEach((p,i)=>{
    overallStats[p].points+=totalPoints[i];
    overallStats[p].darts+=totalDarts[i];
    overallStats[p].busts+=busts[i];
    overallStats[p].schwarzwald+=schwarzwald[i];
  });
  overallStats[winner].wins++;
  if(currentMatch.phase==="Gruppe"){
    renderGroupTable();
    winnerText.textContent=`üèÜ Sieger: ${winner}`;
    nextMatchText.innerHTML=tournament.group.length
      ? `‚ñ∂Ô∏è N√§chstes Spiel:<br>${tournament.group[0].a} vs ${tournament.group[0].b}`
      : `‚ñ∂Ô∏è Halbfinale`;
    winnerPopup.classList.remove("hidden");return;
  }
  if(currentMatch.phase==="Halbfinale"){
    tournament.semiWinners.push(winner);
    tournament.semiLosers.push(loser);
    if(tournament.semiWinners.length===2){
      tournament.third={a:tournament.semiLosers[0],b:tournament.semiLosers[1],phase:"Spiel um Platz 3",res:null};
      tournament.final={a:tournament.semiWinners[0],b:tournament.semiWinners[1],phase:"Finale",res:null};
      tournament.all.push(tournament.third,tournament.final);
    }
    winnerText.textContent=`üèÜ Sieger: ${winner}`;
    nextMatchText.innerHTML=`‚ñ∂Ô∏è N√§chstes Spiel`;
    winnerPopup.classList.remove("hidden");return;
  }
  if(currentMatch.phase==="Spiel um Platz 3"){
    winnerText.textContent=`ü•â Platz 3: ${winner}`;
    nextMatchText.innerHTML=`‚ñ∂Ô∏è Finale`;
    winnerPopup.classList.remove("hidden");return;
  }
  if(currentMatch.phase==="Finale"){
    alert(`ü•á ${winner}\nü•à ${loser}`);
    location.reload();
  }
}
function closeWinnerPopup(){
  winnerPopup.classList.add("hidden");
  if(currentMatch.phase==="Gruppe")nextGroupMatch();
  else if(currentMatch.phase==="Halbfinale")startMatch(tournament.semi.shift()||tournament.third);
  else if(currentMatch.phase==="Spiel um Platz 3")startMatch(tournament.final);
}
function renderGroupTable(){
  let stats={};
  tournament.all.filter(m=>m.phase==="Gruppe"&&m.res).forEach(m=>{
    stats[m.a]??={p:0,w:0,l:0};
    stats[m.b]??={p:0,w:0,l:0};
    let [a,b]=m.res.split(":").map(Number);
    if(a>b){stats[m.a].p+=2;stats[m.a].w++;stats[m.b].l++;}
    else{stats[m.b].p+=2;stats[m.b].w++;stats[m.a].l++;}
  });
  let html=`<h3>üìä Tabelle ‚Äì Gruppenphase</h3>
  <table class="table">
    <tr><th>Spieler</th><th>P</th><th>S</th><th>N</th></tr>`;
  Object.entries(stats).sort((a,b)=>b[1].p-a[1].p)
    .forEach(([n,s])=>{
      html+=`<tr><td>${n}</td><td>${s.p}</td><td>${s.w}</td><td>${s.l}</td></tr>`;
    });
  html+="</table>";
  tournamentPanel.innerHTML=html;
  tournamentPanel.classList.remove("hidden");
}
function openMatches(){
  if(!tournament){alert("Turnier noch nicht gestartet");return;}
  let html=`<table class="table">
    <tr><th>Phase</th><th>Spiel</th><th>Ergebnis</th></tr>`;
  tournament.all.forEach(m=>{
    html+=`<tr><td>${m.phase}</td><td>${m.a} vs ${m.b}</td><td>${m.res||"-"}</td></tr>`;
  });
  html+="</table>";
  matchesContent.innerHTML=html;
  matchesPopup.classList.remove("hidden");
}
</script>

</body>
</html>
